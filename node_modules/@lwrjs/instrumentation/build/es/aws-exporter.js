import { ExportResultCode, hrTimeToMilliseconds, hrTimeToTimeStamp } from '@opentelemetry/core';
// eslint-disable-next-line @typescript-eslint/ban-ts-comment
// @ts-ignore
import { MetricsSender } from '@salesforce/pwa-kit-runtime/utils/ssr-server/metrics-sender.js';
import { RequestHandlerSpan, ViewSpan } from './spans.js';
const DEFAULT_DIMENSIONS = {
    Project: process.env.MOBIFY_PROPERTY_ID,
    Target: process.env.DEPLOY_TARGET,
};
// only report metrics that are used for graphs
const SUPPORTED_SPANS = new Set([
    RequestHandlerSpan.GetView,
    RequestHandlerSpan.GetAsset,
    ViewSpan.GetServerData,
]);
function toDurationMetric(name, span) {
    return {
        name,
        dimensions: DEFAULT_DIMENSIONS,
        timestamp: new Date(hrTimeToTimeStamp(span.startTime)),
        unit: 'Milliseconds',
        value: hrTimeToMilliseconds(span.duration),
    };
}
function toCountMetric(name, span) {
    return {
        name,
        dimensions: DEFAULT_DIMENSIONS,
        timestamp: new Date(hrTimeToTimeStamp(span.startTime)),
        unit: 'Count',
        value: 1,
    };
}
function isDiagnosticsError(span) {
    if (span.status.code === 0) {
        return false;
    }
    for (const event of span.events) {
        if (event.name === 'exception' && event.attributes) {
            return event.attributes['exception.type'] === 'DiagnosticsError';
        }
    }
    return false;
}
function toCustomMetrics(span) {
    const metrics = [];
    // view availability metrics
    if (span.name === RequestHandlerSpan.GetView) {
        metrics.push(toDurationMetric('ResolveViewTime', span));
        if (span.status.code > 0 && !isDiagnosticsError(span)) {
            metrics.push(toCountMetric('ResolveViewErrors', span));
        }
    }
    // asset availability metrics
    if (span.name === RequestHandlerSpan.GetAsset) {
        metrics.push(toDurationMetric('ResolveAssetTime', span));
        if (span.status.code > 0 && !isDiagnosticsError(span)) {
            metrics.push(toCountMetric('ResolveAssetErrors', span));
        }
    }
    // external request availability metrics
    if (span.name === ViewSpan.GetServerData) {
        // reusing pwa-kit metric name for `getServerData` duration
        metrics.push(toDurationMetric('ExternalRequestTime', span));
        if (span.status.code > 0 && !isDiagnosticsError(span)) {
            // reusing pwa-kit metric name for `getServerData` errors
            metrics.push(toCountMetric('ExternalRequestFailed', span));
        }
    }
    return metrics;
}
export class AWSExporter {
    constructor() {
        this.metricsSender = MetricsSender.getSender();
        this.isShutdown = false;
        this.isLambda = process.env.AWS_LAMBDA_FUNCTION_NAME;
    }
    export(spans, done) {
        if (this.isShutdown) {
            done({
                code: ExportResultCode.FAILED,
                error: new Error('Failed to export spans: Exporter shutdown'),
            });
            return;
        }
        // log all spans even if they are not exported as a custom metric
        this.log(spans);
        if (!this.isLambda) {
            done({ code: ExportResultCode.SUCCESS });
            return;
        }
        this.send(spans.filter(({ name }) => SUPPORTED_SPANS.has(name)), done);
    }
    log(spans) {
        for (const span of spans) {
            // eslint-disable-next-line
            console.log(JSON.stringify({
                traceId: span.spanContext().traceId,
                parentId: span.parentSpanId,
                traceState: span.spanContext().traceState?.serialize(),
                name: span.name,
                id: span.spanContext().spanId,
                kind: span.kind,
                timestamp: hrTimeToTimeStamp(span.startTime),
                duration: hrTimeToMilliseconds(span.duration),
                attributes: span.attributes,
                status: span.status,
                events: span.events,
                links: span.links,
            }));
        }
    }
    send(spans, done) {
        this.metricsSender.send(spans.map(toCustomMetrics).flat());
        done({ code: ExportResultCode.SUCCESS });
    }
    async shutdown() {
        this.isShutdown = true;
    }
}
//# sourceMappingURL=aws-exporter.js.map